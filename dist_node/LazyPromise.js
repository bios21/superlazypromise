'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) arr2[i] = arr[i]; return arr2; } else { return Array.from(arr); } }

var _module = null,
    _exports = null;
if (typeof module !== 'undefined' && module.exports) {
    _exports = module.exports;
    _module = {};
} else {
    _exports = window;
    _module = _exports;
}

((module, exports, root) => {
    var rawAsap = (() => {
        function _rawAsap(task) {
            if (!queue.length) {
                requestFlush();
                flushing = true;
            }

            queue[queue.length] = task;
        }

        var queue = [],
            flushing = false,
            requestFlush = null,
            index = 0,
            capacity = 1024;

        function flush() {
            while (index < queue.length) {
                var currentIndex = index;

                index = index + 1;
                queue[currentIndex].call();

                if (index > capacity) {
                    for (var scan = 0, newLength = queue.length - index; scan < newLength; scan++) {
                        queue[scan] = queue[scan + index];
                    }
                    queue.length -= index;
                    index = 0;
                }
            }
            queue.length = 0;
            index = 0;
            flushing = false;
        }

        function makeRequestCallFromTimer(callback) {
            return function requestCall() {
                var timeoutHandle = setTimeout(handleTimer, 0);

                var intervalHandle = setInterval(handleTimer, 50);

                function handleTimer() {
                    clearTimeout(timeoutHandle);
                    clearInterval(intervalHandle);
                    callback();
                }
            };
        }

        _rawAsap.makeRequestCallFromTimer = makeRequestCallFromTimer;

        const BrowserMutationObserver = root.MutationObserver || root.WebKitMutationObserver;

        if (typeof BrowserMutationObserver === 'function') {
            requestFlush = makeRequestCallFromMutationObserver(flush);
        } else {
            requestFlush = makeRequestCallFromTimer(flush);
        }

        _rawAsap.requestFlush = requestFlush;

        function makeRequestCallFromMutationObserver(callback) {
            var toggle = 1;
            var observer = new BrowserMutationObserver(callback);
            var node = document.createTextNode("");
            observer.observe(node, { characterData: true });
            return function requestCall() {
                toggle = -toggle;
                node.data = toggle;
            };
        }

        return _rawAsap;
    })();

    var asap = (() => {
        var freeTasks = [],
            pendingErrors = [];

        const requestErrorThrow = rawAsap.makeRequestCallFromTimer(() => {
            if (pendingErrors.length) {
                throw pendingErrors.shift();
            }
        });

        class RawTask {
            constructor() {
                this.task = null;
            }

            call() {
                try {
                    this.task.call();
                } catch (error) {
                    pendingErrors.push(error);
                    requestErrorThrow();
                } finally {
                    this.task = null;
                    freeTasks[freeTasks.length] = this;
                }
            }
        }

        function _asap(task) {
            let rawTask;
            if (freeTasks.length) {
                rawTask = freeTasks.pop();
            } else {
                rawTask = new RawTask();
            }
            rawTask.task = task;
            rawAsap(rawTask);
        }

        return _asap;
    })();

    class LazyPromise {

        static get rawAsap() {
            return rawAsap;
        }
        static get asap() {
            return asap;
        }

        constructor(fn) {
            if (typeof fn !== 'function') {
                throw new TypeError(`Bro' ... fn means function, not some shit like ${ typeof fn } you try to give. Tss`);
            }

            this.created = false;
            this.fn = fn;
            this.promise = null;
        }

        _createPromise() {
            this.promise = new Promise((resolve, reject) => {
                asap(() => {
                    try {
                        this.fn(resolve, reject);
                    } catch (e) {
                        reject(e);
                    }
                });
            });

            this.created = true;
        }

        updatePromise(promise) {
            if (!!promise && promise.__proto__.constructor.name === 'Promise') {
                this.promise = Promise.resolve(promise);
                this.created = true;
            }
        }

        then(onResolved, onRejected) {
            if (!this.created) this._createPromise();
            this.promise && this.promise.then(onResolved, onRejected);
            return this;
        }

        catch(onRejected) {
            if (!this.created) this._createPromise();
            this.promise && this.promise.catch(onRejected);
            return this;
        }

        kill() {
            this.promise = null;
        }
    }

    class SuperLazyPromise extends LazyPromise {
        constructor(fn) {
            super(fn);

            this.superLazyThenCatch = [];
        }

        then(onResolved, onRejected) {
            if (!this.created) {
                this.superLazyThenCatch.push([onResolved, onRejected]);
                return this;
            } else {
                return super.then(onResolved, onRejected);
            }
        }

        catch(onRejected) {
            if (!this.created) {
                if (onRejected && typeof onRejected === 'function') {
                    this.superLazyThenCatch.push(onRejected);
                }
                return this;
            } else {
                return super.catch(onRejected);
            }
        }

        awake(fn) {
            if (typeof fn === 'function') {
                this.fn = fn;
                this.created = false;
            }
            this.created || super._createPromise();
            for (let resRej of this.superLazyThenCatch) {
                if (typeof resRej === 'function') {
                    asap(() => {
                        this.catch(resRej);
                    });
                } else {
                    asap(() => {
                        this.then.apply(this, _toConsumableArray(resRej));
                    });
                }
            }
        }
    }

    exports.LazyPromise = LazyPromise;
    exports.SuperLazyPromise = SuperLazyPromise;
})(_module, _exports, typeof global !== 'undefined' ? global : window);
//# sourceMappingURL=data:application/json;base64,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SCxxQkFGRDtBQUdIO0FBQ0o7QUFDSjtBQTlEc0M7O0FBaUUzQyxZQUFRLFdBQVIsR0FBc0IsV0FBdEI7QUFDQSxZQUFRLGdCQUFSLEdBQTJCLGdCQUEzQjtBQUNILENBMWVELEVBMGVHLE9BMWVILEVBMGVZLFFBMWVaLEVBMGVzQixPQUFPLE1BQVAsS0FBbUIsV0FBbkIsR0FBaUMsTUFBakMsR0FBMEMsTUExZWhFIiwiZmlsZSI6IkxhenlQcm9taXNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgX21vZHVsZSA9IG51bGwsXG4gICAgX2V4cG9ydHMgPSBudWxsO1xuaWYgKHR5cGVvZihtb2R1bGUpICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykge1xuICAgIF9leHBvcnRzID0gbW9kdWxlLmV4cG9ydHM7XG4gICAgX21vZHVsZSA9IHt9O1xufSBlbHNlIHtcbiAgICBfZXhwb3J0cyA9IHdpbmRvdztcbiAgICBfbW9kdWxlID0gX2V4cG9ydHM7XG59XG5cbigobW9kdWxlLCBleHBvcnRzLCByb290KSA9PiB7XG5cbiAgICAvKipcbiAgICAgKiBVc2UgdGhlIGZhc3Rlc3QgbWVhbnMgcG9zc2libGUgdG8gZXhlY3V0ZSBhIHRhc2sgaW4gaXRzIG93biB0dXJuLCB3aXRoIHByaW9yaXR5IG92ZXIgb3RoZXIgZXZlbnRzIGluY2x1ZGluZyBJTyxcbiAgICAgKiBhbmltYXRpb24sIHJlZmxvdywgYW5kIHJlZHJhdyBldmVudHMgaW4gYnJvd3NlcnMuXG4gICAgICpcbiAgICAgKiBBbiBleGNlcHRpb24gdGhyb3duIGJ5IGEgdGFzayB3aWxsIHBlcm1hbmVudGx5IGludGVycnVwdCB0aGUgcHJvY2Vzc2luZyBvZiBzdWJzZXF1ZW50IHRhc2tzLiBUaGUgaGlnaGVyIGxldmVsXG4gICAgICogYGFzYXBgIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpZiBhbiBleGNlcHRpb24gaXMgdGhyb3duIGJ5IGEgdGFzaywgdGhhdCB0aGUgdGFzayBxdWV1ZSB3aWxsIGNvbnRpbnVlIGZsdXNoaW5nIGFzXG4gICAgICogc29vbiBhcyBwb3NzaWJsZSwgYnV0IGlmIHlvdSB1c2UgYHJhd0FzYXBgIGRpcmVjdGx5LCB5b3UgYXJlIHJlc3BvbnNpYmxlIHRvIGVpdGhlciBlbnN1cmUgdGhhdCBubyBleGNlcHRpb25zIGFyZVxuICAgICAqIHRocm93biBmcm9tIHlvdXIgdGFzaywgb3IgdG8gbWFudWFsbHkgY2FsbCBgcmF3QXNhcC5yZXF1ZXN0Rmx1c2hgIGlmIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3tjYWxsfX0gdGFzayBBIGNhbGxhYmxlIG9iamVjdCwgdHlwaWNhbGx5IGEgZnVuY3Rpb24gdGhhdCB0YWtlcyBubyBhcmd1bWVudHMuXG4gICAgICogQGFsaWFzIExhenlQcm9taXNlLnJhd0FzYXBcbiAgICAgKi9cbiAgICB2YXIgcmF3QXNhcCA9ICgoKSA9PiB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAcGFyYW0ge3tjYWxsfX0gdGFza1xuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gX3Jhd0FzYXAodGFzaykge1xuICAgICAgICAgICAgaWYgKCFxdWV1ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Rmx1c2goKTtcbiAgICAgICAgICAgICAgICBmbHVzaGluZyA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGFycmF5LnB1c2ggd2l0aG91dCBmbiBjYWxsXG4gICAgICAgICAgICBxdWV1ZVtxdWV1ZS5sZW5ndGhdID0gdGFzaztcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBxdWV1ZSA9IFtdLFxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBPbmNlIGEgZmx1c2ggaGFzIGJlZW4gcmVxdWVzdGVkLCBubyBmdXJ0aGVyIGNhbGxzIHRvIGByZXF1ZXN0Rmx1c2hgIGFyZVxuICAgICAgICAgICAgICogbmVjZXNzYXJ5IHVudGlsIHRoZSBuZXh0IGBmbHVzaGAgY29tcGxldGVzLlxuICAgICAgICAgICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGZsdXNoaW5nID0gZmFsc2UsXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIGByZXF1ZXN0Rmx1c2hgIGlzIGFuIGltcGxlbWVudGF0aW9uLXNwZWNpZmljIG1ldGhvZCB0aGF0IGF0dGVtcHRzIHRvIGtpY2tcbiAgICAgICAgICAgICAqIG9mZiBhIGBmbHVzaGAgZXZlbnQgYXMgcXVpY2tseSBhcyBwb3NzaWJsZS4gYGZsdXNoYCB3aWxsIGF0dGVtcHQgdG8gZXhoYXVzdFxuICAgICAgICAgICAgICogdGhlIGV2ZW50IHF1ZXVlIGJlZm9yZSB5aWVsZGluZyB0byB0aGUgYnJvd3NlcidzIG93biBldmVudCBsb29wLlxuICAgICAgICAgICAgICogQHR5cGUgez9GdW5jdGlvbn1cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgcmVxdWVzdEZsdXNoID0gbnVsbCxcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogVGhlIHBvc2l0aW9uIG9mIHRoZSBuZXh0IHRhc2sgdG8gZXhlY3V0ZSBpbiB0aGUgdGFzayBxdWV1ZS4gVGhpcyBpc1xuICAgICAgICAgICAgICogcHJlc2VydmVkIGJldHdlZW4gY2FsbHMgdG8gYGZsdXNoYCBzbyB0aGF0IGl0IGNhbiBiZSByZXN1bWVkIGlmXG4gICAgICAgICAgICAgKiBhIHRhc2sgdGhyb3dzIGFuIGV4Y2VwdGlvbi5cbiAgICAgICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGluZGV4ID0gMCxcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogSWYgYSB0YXNrIHNjaGVkdWxlcyBhZGRpdGlvbmFsIHRhc2tzIHJlY3Vyc2l2ZWx5LCB0aGUgdGFzayBxdWV1ZSBjYW4gZ3Jvd1xuICAgICAgICAgICAgICogdW5ib3VuZGVkLiBUbyBwcmV2ZW50IG1lbW9yeSBleGhhdXN0aW9uLCB0aGUgdGFzayBxdWV1ZSB3aWxsIHBlcmlvZGljYWxseVxuICAgICAgICAgICAgICogdHJ1bmNhdGUgYWxyZWFkeS1jb21wbGV0ZWQgdGFza3MuXG4gICAgICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBjYXBhY2l0eSA9IDEwMjQ7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSBmbHVzaCBmdW5jdGlvbiBwcm9jZXNzZXMgYWxsIHRhc2tzIHRoYXQgaGF2ZSBiZWVuIHNjaGVkdWxlZCB3aXRoXG4gICAgICAgICAqIGByYXdBc2FwYCB1bmxlc3MgYW5kIHVudGlsIG9uZSBvZiB0aG9zZSB0YXNrcyB0aHJvd3MgYW4gZXhjZXB0aW9uLlxuICAgICAgICAgKiBJZiBhIHRhc2sgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgYGZsdXNoYCBlbnN1cmVzIHRoYXQgaXRzIHN0YXRlIHdpbGwgcmVtYWluXG4gICAgICAgICAqIGNvbnNpc3RlbnQgYW5kIHdpbGwgcmVzdW1lIHdoZXJlIGl0IGxlZnQgb2ZmIHdoZW4gY2FsbGVkIGFnYWluLlxuICAgICAgICAgKiBIb3dldmVyLCBgZmx1c2hgIGRvZXMgbm90IG1ha2UgYW55IGFycmFuZ2VtZW50cyB0byBiZSBjYWxsZWQgYWdhaW4gaWYgYW5cbiAgICAgICAgICogZXhjZXB0aW9uIGlzIHRocm93bi5cbiAgICAgICAgICovXG4gICAgICAgIGZ1bmN0aW9uIGZsdXNoKCkge1xuICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgcXVldWUubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRJbmRleCA9IGluZGV4O1xuICAgICAgICAgICAgICAgIC8vIEFkdmFuY2UgdGhlIGluZGV4IGJlZm9yZSBjYWxsaW5nIHRoZSB0YXNrLiBUaGlzIGVuc3VyZXMgdGhhdCB3ZSB3aWxsXG4gICAgICAgICAgICAgICAgLy8gYmVnaW4gZmx1c2hpbmcgb24gdGhlIG5leHQgdGFzayB0aGUgdGFzayB0aHJvd3MgYW4gZXJyb3IuXG4gICAgICAgICAgICAgICAgaW5kZXggPSBpbmRleCArIDE7XG4gICAgICAgICAgICAgICAgcXVldWVbY3VycmVudEluZGV4XS5jYWxsKCk7XG4gICAgICAgICAgICAgICAgLy8gUHJldmVudCBsZWFraW5nIG1lbW9yeSBmb3IgbG9uZyBjaGFpbnMgb2YgcmVjdXJzaXZlIGNhbGxzIHRvIGBhc2FwYC5cbiAgICAgICAgICAgICAgICAvLyBJZiB3ZSBjYWxsIGBhc2FwYCB3aXRoaW4gdGFza3Mgc2NoZWR1bGVkIGJ5IGBhc2FwYCwgdGhlIHF1ZXVlIHdpbGxcbiAgICAgICAgICAgICAgICAvLyBncm93LCBidXQgdG8gYXZvaWQgYW4gTyhuKSB3YWxrIGZvciBldmVyeSB0YXNrIHdlIGV4ZWN1dGUsIHdlIGRvbid0XG4gICAgICAgICAgICAgICAgLy8gc2hpZnQgdGFza3Mgb2ZmIHRoZSBxdWV1ZSBhZnRlciB0aGV5IGhhdmUgYmVlbiBleGVjdXRlZC5cbiAgICAgICAgICAgICAgICAvLyBJbnN0ZWFkLCB3ZSBwZXJpb2RpY2FsbHkgc2hpZnQgMTAyNCB0YXNrcyBvZmYgdGhlIHF1ZXVlLlxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IGNhcGFjaXR5KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIE1hbnVhbGx5IHNoaWZ0IGFsbCB2YWx1ZXMgc3RhcnRpbmcgYXQgdGhlIGluZGV4IGJhY2sgdG8gdGhlXG4gICAgICAgICAgICAgICAgICAgIC8vIGJlZ2lubmluZyBvZiB0aGUgcXVldWUuXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHNjYW4gPSAwLCBuZXdMZW5ndGggPSBxdWV1ZS5sZW5ndGggLSBpbmRleDsgc2NhbiA8IG5ld0xlbmd0aDsgc2NhbisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBxdWV1ZVtzY2FuXSA9IHF1ZXVlW3NjYW4gKyBpbmRleF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcXVldWUubGVuZ3RoIC09IGluZGV4O1xuICAgICAgICAgICAgICAgICAgICBpbmRleCA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcXVldWUubGVuZ3RoID0gMDtcbiAgICAgICAgICAgIGluZGV4ID0gMDtcbiAgICAgICAgICAgIGZsdXNoaW5nID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogVGhlIG1lc3NhZ2UgY2hhbm5lbCB0ZWNobmlxdWUgd2FzIGRpc2NvdmVyZWQgYnkgTWFsdGUgVWJsIGFuZCB3YXMgdGhlXG4gICAgICAgICAqIG9yaWdpbmFsIGZvdW5kYXRpb24gZm9yIHRoaXMgbGlicmFyeS5cbiAgICAgICAgICogaHR0cDovL3d3dy5ub25ibG9ja2luZy5pby8yMDExLzA2L3dpbmRvd25leHR0aWNrLmh0bWxcbiAgICAgICAgICpcbiAgICAgICAgICogU2FmYXJpIDYuMC41IChhdCBsZWFzdCkgaW50ZXJtaXR0ZW50bHkgZmFpbHMgdG8gY3JlYXRlIG1lc3NhZ2UgcG9ydHMgb24gYVxuICAgICAgICAgKiBwYWdlJ3MgZmlyc3QgbG9hZC4gVGhhbmtmdWxseSwgdGhpcyB2ZXJzaW9uIG9mIFNhZmFyaSBzdXBwb3J0c1xuICAgICAgICAgKiBNdXRhdGlvbk9ic2VydmVycywgc28gd2UgZG9uJ3QgbmVlZCB0byBmYWxsIGJhY2sgaW4gdGhhdCBjYXNlLlxuICAgICAgICAgKlxuICAgICAgICAgKiBmdW5jdGlvbiBtYWtlUmVxdWVzdENhbGxGcm9tTWVzc2FnZUNoYW5uZWwoY2FsbGJhY2spIHtcbiAgICAgICAgICogICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7XG4gICAgICAgICAqICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IGNhbGxiYWNrO1xuICAgICAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uIHJlcXVlc3RDYWxsKCkge1xuICAgICAgICAgKiAgICAgICAgIGNoYW5uZWwucG9ydDIucG9zdE1lc3NhZ2UoMCk7XG4gICAgICAgICAqICAgICB9O1xuICAgICAgICAgKiB9XG4gICAgICAgICAqXG4gICAgICAgICAqIEZvciByZWFzb25zIGV4cGxhaW5lZCBhYm92ZSwgd2UgYXJlIGFsc28gdW5hYmxlIHRvIHVzZSBgc2V0SW1tZWRpYXRlYFxuICAgICAgICAgKiB1bmRlciBhbnkgY2lyY3Vtc3RhbmNlcy5cbiAgICAgICAgICogRXZlbiBpZiB3ZSB3ZXJlLCB0aGVyZSBpcyBhbm90aGVyIGJ1ZyBpbiBJbnRlcm5ldCBFeHBsb3JlciAxMC5cbiAgICAgICAgICogSXQgaXMgbm90IHN1ZmZpY2llbnQgdG8gYXNzaWduIGBzZXRJbW1lZGlhdGVgIHRvIGByZXF1ZXN0Rmx1c2hgIGJlY2F1c2VcbiAgICAgICAgICogYHNldEltbWVkaWF0ZWAgbXVzdCBiZSBjYWxsZWQgKmJ5IG5hbWUqIGFuZCB0aGVyZWZvcmUgbXVzdCBiZSB3cmFwcGVkIGluIGFcbiAgICAgICAgICogY2xvc3VyZS5cbiAgICAgICAgICogTmV2ZXIgZm9yZ2V0LlxuICAgICAgICAgKlxuICAgICAgICAgKiBmdW5jdGlvbiBtYWtlUmVxdWVzdENhbGxGcm9tU2V0SW1tZWRpYXRlKGNhbGxiYWNrKSB7XG4gICAgICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24gcmVxdWVzdENhbGwoKSB7XG4gICAgICAgICAqICAgICAgICAgc2V0SW1tZWRpYXRlKGNhbGxiYWNrKTtcbiAgICAgICAgICogICAgIH07XG4gICAgICAgICAqIH1cbiAgICAgICAgICpcbiAgICAgICAgICogU2FmYXJpIDYuMCBoYXMgYSBwcm9ibGVtIHdoZXJlIHRpbWVycyB3aWxsIGdldCBsb3N0IHdoaWxlIHRoZSB1c2VyIGlzXG4gICAgICAgICAqIHNjcm9sbGluZy4gVGhpcyBwcm9ibGVtIGRvZXMgbm90IGltcGFjdCBBU0FQIGJlY2F1c2UgU2FmYXJpIDYuMCBzdXBwb3J0c1xuICAgICAgICAgKiBtdXRhdGlvbiBvYnNlcnZlcnMsIHNvIHRoYXQgaW1wbGVtZW50YXRpb24gaXMgdXNlZCBpbnN0ZWFkLlxuICAgICAgICAgKiBIb3dldmVyLCBpZiB3ZSBldmVyIGVsZWN0IHRvIHVzZSB0aW1lcnMgaW4gU2FmYXJpLCB0aGUgcHJldmFsZW50IHdvcmstYXJvdW5kXG4gICAgICAgICAqIGlzIHRvIGFkZCBhIHNjcm9sbCBldmVudCBsaXN0ZW5lciB0aGF0IGNhbGxzIGZvciBhIGZsdXNoLlxuICAgICAgICAgKlxuICAgICAgICAgKiBgc2V0VGltZW91dGAgZG9lcyBub3QgY2FsbCB0aGUgcGFzc2VkIGNhbGxiYWNrIGlmIHRoZSBkZWxheSBpcyBsZXNzIHRoYW5cbiAgICAgICAgICogYXBwcm94aW1hdGVseSA3IGluIHdlYiB3b3JrZXJzIGluIEZpcmVmb3ggOCB0aHJvdWdoIDE4LCBhbmQgc29tZXRpbWVzIG5vdFxuICAgICAgICAgKiBldmVuIHRoZW4uXG4gICAgICAgICAqXG4gICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrXG4gICAgICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufVxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gbWFrZVJlcXVlc3RDYWxsRnJvbVRpbWVyKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gcmVxdWVzdENhbGwoKSB7XG4gICAgICAgICAgICAgICAgLy8gV2UgZGlzcGF0Y2ggYSB0aW1lb3V0IHdpdGggYSBzcGVjaWZpZWQgZGVsYXkgb2YgMCBmb3IgZW5naW5lcyB0aGF0XG4gICAgICAgICAgICAgICAgLy8gY2FuIHJlbGlhYmx5IGFjY29tbW9kYXRlIHRoYXQgcmVxdWVzdC4gVGhpcyB3aWxsIHVzdWFsbHkgYmUgc25hcHBlZFxuICAgICAgICAgICAgICAgIC8vIHRvIGEgNCBtaWxpc2Vjb25kIGRlbGF5LCBidXQgb25jZSB3ZSdyZSBmbHVzaGluZywgdGhlcmUncyBubyBkZWxheVxuICAgICAgICAgICAgICAgIC8vIGJldHdlZW4gZXZlbnRzLlxuICAgICAgICAgICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gc2V0VGltZW91dChoYW5kbGVUaW1lciwgMCk7XG4gICAgICAgICAgICAgICAgLy8gSG93ZXZlciwgc2luY2UgdGhpcyB0aW1lciBnZXRzIGZyZXF1ZW50bHkgZHJvcHBlZCBpbiBGaXJlZm94XG4gICAgICAgICAgICAgICAgLy8gd29ya2Vycywgd2UgZW5saXN0IGFuIGludGVydmFsIGhhbmRsZSB0aGF0IHdpbGwgdHJ5IHRvIGZpcmVcbiAgICAgICAgICAgICAgICAvLyBhbiBldmVudCAyMCB0aW1lcyBwZXIgc2Vjb25kIHVudGlsIGl0IHN1Y2NlZWRzLlxuICAgICAgICAgICAgICAgIHZhciBpbnRlcnZhbEhhbmRsZSA9IHNldEludGVydmFsKGhhbmRsZVRpbWVyLCA1MCk7XG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lcigpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gV2hpY2hldmVyIHRpbWVyIHN1Y2NlZWRzIHdpbGwgY2FuY2VsIGJvdGggdGltZXJzIGFuZFxuICAgICAgICAgICAgICAgICAgICAvLyBleGVjdXRlIHRoZSBjYWxsYmFjay5cbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRIYW5kbGUpO1xuICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSGFuZGxlKTtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgX3Jhd0FzYXAubWFrZVJlcXVlc3RDYWxsRnJvbVRpbWVyID0gbWFrZVJlcXVlc3RDYWxsRnJvbVRpbWVyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBgcmVxdWVzdEZsdXNoYCBpcyBpbXBsZW1lbnRlZCB1c2luZyBhIHN0cmF0ZWd5IGJhc2VkIG9uIGRhdGEgY29sbGVjdGVkIGZyb21cbiAgICAgICAgICogZXZlcnkgYXZhaWxhYmxlIFNhdWNlTGFicyBTZWxlbml1bSB3ZWIgZHJpdmVyIHdvcmtlciBhdCB0aW1lIG9mIHdyaXRpbmcuXG4gICAgICAgICAqIGh0dHBzOi8vZG9jcy5nb29nbGUuY29tL3NwcmVhZHNoZWV0cy9kLzFtRy01VVlHdXA1cXhHZEVNV2toUDZCV0N6MDUzTlViMkUxUW9VVFUxNnVBL2VkaXQjZ2lkPTc4MzcyNDU5M1xuICAgICAgICAgKlxuICAgICAgICAgKiBTYWZhcmkgNiBhbmQgNi4xIGZvciBkZXNrdG9wLCBpUGFkLCBhbmQgaVBob25lIGFyZSB0aGUgb25seSBicm93c2VycyB0aGF0XG4gICAgICAgICAqIGhhdmUgV2ViS2l0TXV0YXRpb25PYnNlcnZlciBidXQgbm90IHVuLXByZWZpeGVkIE11dGF0aW9uT2JzZXJ2ZXIuXG4gICAgICAgICAqIE11c3QgdXNlIGBnbG9iYWxgIGluc3RlYWQgb2YgYHdpbmRvd2AgdG8gd29yayBpbiBib3RoIGZyYW1lcyBhbmQgd2ViXG4gICAgICAgICAqIHdvcmtlcnMuIGBnbG9iYWxgIGlzIGEgcHJvdmlzaW9uIG9mIEJyb3dzZXJpZnksIE1yLCBNcnMsIG9yIE1vcC5cbiAgICAgICAgICogQHR5cGUge011dGF0aW9uT2JzZXJ2ZXJ9XG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBCcm93c2VyTXV0YXRpb25PYnNlcnZlciA9IHJvb3QuTXV0YXRpb25PYnNlcnZlciB8fCByb290LldlYktpdE11dGF0aW9uT2JzZXJ2ZXI7XG5cbiAgICAgICAgLy8gTXV0YXRpb25PYnNlcnZlcnMgYXJlIGRlc2lyYWJsZSBiZWNhdXNlIHRoZXkgaGF2ZSBoaWdoIHByaW9yaXR5IGFuZCB3b3JrXG4gICAgICAgIC8vIHJlbGlhYmx5IGV2ZXJ5d2hlcmUgdGhleSBhcmUgaW1wbGVtZW50ZWQuXG4gICAgICAgIC8vIFRoZXkgYXJlIGltcGxlbWVudGVkIGluIGFsbCBtb2Rlcm4gYnJvd3NlcnMuXG4gICAgICAgIC8vXG4gICAgICAgIC8vIC0gQW5kcm9pZCA0LTQuM1xuICAgICAgICAvLyAtIENocm9tZSAyNi0zNFxuICAgICAgICAvLyAtIEZpcmVmb3ggMTQtMjlcbiAgICAgICAgLy8gLSBJbnRlcm5ldCBFeHBsb3JlciAxMVxuICAgICAgICAvLyAtIGlQYWQgU2FmYXJpIDYtNy4xXG4gICAgICAgIC8vIC0gaVBob25lIFNhZmFyaSA3LTcuMVxuICAgICAgICAvLyAtIFNhZmFyaSA2LTdcbiAgICAgICAgaWYgKHR5cGVvZiBCcm93c2VyTXV0YXRpb25PYnNlcnZlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgcmVxdWVzdEZsdXNoID0gbWFrZVJlcXVlc3RDYWxsRnJvbU11dGF0aW9uT2JzZXJ2ZXIoZmx1c2gpO1xuXG4gICAgICAgIC8vIE1lc3NhZ2VDaGFubmVscyBhcmUgZGVzaXJhYmxlIGJlY2F1c2UgdGhleSBnaXZlIGRpcmVjdCBhY2Nlc3MgdG8gdGhlIEhUTUxcbiAgICAgICAgLy8gdGFzayBxdWV1ZSwgYXJlIGltcGxlbWVudGVkIGluIEludGVybmV0IEV4cGxvcmVyIDEwLCBTYWZhcmkgNS4wLTEsIGFuZCBPcGVyYVxuICAgICAgICAvLyAxMS0xMiwgYW5kIGluIHdlYiB3b3JrZXJzIGluIG1hbnkgZW5naW5lcy5cbiAgICAgICAgLy8gQWx0aG91Z2ggbWVzc2FnZSBjaGFubmVscyB5aWVsZCB0byBhbnkgcXVldWVkIHJlbmRlcmluZyBhbmQgSU8gdGFza3MsIHRoZXlcbiAgICAgICAgLy8gd291bGQgYmUgYmV0dGVyIHRoYW4gaW1wb3NpbmcgdGhlIDRtcyBkZWxheSBvZiB0aW1lcnMuXG4gICAgICAgIC8vIEhvd2V2ZXIsIHRoZXkgZG8gbm90IHdvcmsgcmVsaWFibHkgaW4gSW50ZXJuZXQgRXhwbG9yZXIgb3IgU2FmYXJpLlxuXG4gICAgICAgIC8vIEludGVybmV0IEV4cGxvcmVyIDEwIGlzIHRoZSBvbmx5IGJyb3dzZXIgdGhhdCBoYXMgc2V0SW1tZWRpYXRlIGJ1dCBkb2VzXG4gICAgICAgIC8vIG5vdCBoYXZlIE11dGF0aW9uT2JzZXJ2ZXJzLlxuICAgICAgICAvLyBBbHRob3VnaCBzZXRJbW1lZGlhdGUgeWllbGRzIHRvIHRoZSBicm93c2VyJ3MgcmVuZGVyZXIsIGl0IHdvdWxkIGJlXG4gICAgICAgIC8vIHByZWZlcnJhYmxlIHRvIGZhbGxpbmcgYmFjayB0byBzZXRUaW1lb3V0IHNpbmNlIGl0IGRvZXMgbm90IGhhdmVcbiAgICAgICAgLy8gdGhlIG1pbmltdW0gNG1zIHBlbmFsdHkuXG4gICAgICAgIC8vIFVuZm9ydHVuYXRlbHkgdGhlcmUgYXBwZWFycyB0byBiZSBhIGJ1ZyBpbiBJbnRlcm5ldCBFeHBsb3JlciAxMCBNb2JpbGUgKGFuZFxuICAgICAgICAvLyBEZXNrdG9wIHRvIGEgbGVzc2VyIGV4dGVudCkgdGhhdCByZW5kZXJzIGJvdGggc2V0SW1tZWRpYXRlIGFuZFxuICAgICAgICAvLyBNZXNzYWdlQ2hhbm5lbCB1c2VsZXNzIGZvciB0aGUgcHVycG9zZXMgb2YgQVNBUC5cbiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xL2lzc3Vlcy8zOTZcblxuICAgICAgICAvLyBUaW1lcnMgYXJlIGltcGxlbWVudGVkIHVuaXZlcnNhbGx5LlxuICAgICAgICAvLyBXZSBmYWxsIGJhY2sgdG8gdGltZXJzIGluIHdvcmtlcnMgaW4gbW9zdCBlbmdpbmVzLCBhbmQgaW4gZm9yZWdyb3VuZFxuICAgICAgICAvLyBjb250ZXh0cyBpbiB0aGUgZm9sbG93aW5nIGJyb3dzZXJzLlxuICAgICAgICAvLyBIb3dldmVyLCBub3RlIHRoYXQgZXZlbiB0aGlzIHNpbXBsZSBjYXNlIHJlcXVpcmVzIG51YW5jZXMgdG8gb3BlcmF0ZSBpbiBhXG4gICAgICAgIC8vIGJyb2FkIHNwZWN0cnVtIG9mIGJyb3dzZXJzLlxuICAgICAgICAvL1xuICAgICAgICAvLyAtIEZpcmVmb3ggMy0xM1xuICAgICAgICAvLyAtIEludGVybmV0IEV4cGxvcmVyIDYtOVxuICAgICAgICAvLyAtIGlQYWQgU2FmYXJpIDQuM1xuICAgICAgICAvLyAtIEx5bnggMi44LjdcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlcXVlc3RGbHVzaCA9IG1ha2VSZXF1ZXN0Q2FsbEZyb21UaW1lcihmbHVzaCk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogYHJlcXVlc3RGbHVzaGAgcmVxdWVzdHMgdGhhdCB0aGUgaGlnaCBwcmlvcml0eSBldmVudCBxdWV1ZSBiZSBmbHVzaGVkIGFzXG4gICAgICAgICAqIHNvb24gYXMgcG9zc2libGUuXG4gICAgICAgICAqIFRoaXMgaXMgdXNlZnVsIHRvIHByZXZlbnQgYW4gZXJyb3IgdGhyb3duIGluIGEgdGFzayBmcm9tIHN0YWxsaW5nIHRoZSBldmVudFxuICAgICAgICAgKiBxdWV1ZSBpZiB0aGUgZXhjZXB0aW9uIGhhbmRsZWQgYnkgTm9kZS5qc+KAmXNcbiAgICAgICAgICogYHByb2Nlc3Mub24oXCJ1bmNhdWdodEV4Y2VwdGlvblwiKWAgb3IgYnkgYSBkb21haW4uXG4gICAgICAgICAqIEB0eXBlIHs/RnVuY3Rpb259XG4gICAgICAgICAqL1xuICAgICAgICBfcmF3QXNhcC5yZXF1ZXN0Rmx1c2ggPSByZXF1ZXN0Rmx1c2g7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRvIHJlcXVlc3QgYSBoaWdoIHByaW9yaXR5IGV2ZW50LCB3ZSBpbmR1Y2UgYSBtdXRhdGlvbiBvYnNlcnZlciBieSB0b2dnbGluZ1xuICAgICAgICAgKiB0aGUgdGV4dCBvZiBhIHRleHQgbm9kZSBiZXR3ZWVuIFwiMVwiIGFuZCBcIi0xXCIuXG4gICAgICAgICAqXG4gICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrXG4gICAgICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn1cbiAgICAgICAgICovXG4gICAgICAgIGZ1bmN0aW9uIG1ha2VSZXF1ZXN0Q2FsbEZyb21NdXRhdGlvbk9ic2VydmVyKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICB2YXIgdG9nZ2xlID0gMTtcbiAgICAgICAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBCcm93c2VyTXV0YXRpb25PYnNlcnZlcihjYWxsYmFjayk7XG4gICAgICAgICAgICB2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFwiXCIpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShub2RlLCB7Y2hhcmFjdGVyRGF0YTogdHJ1ZX0pO1xuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHJlcXVlc3RDYWxsKCkge1xuICAgICAgICAgICAgICAgIHRvZ2dsZSA9IC10b2dnbGU7XG4gICAgICAgICAgICAgICAgbm9kZS5kYXRhID0gdG9nZ2xlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBfcmF3QXNhcDtcbiAgICB9KSgpO1xuXG4gICAgLyoqXG4gICAgICogQ2FsbHMgYSB0YXNrIGFzIHNvb24gYXMgcG9zc2libGUgYWZ0ZXIgcmV0dXJuaW5nLCBpbiBpdHMgb3duIGV2ZW50LCB3aXRoIHByaW9yaXR5IG92ZXIgb3RoZXIgZXZlbnRzIGxpa2VcbiAgICAgKiBhbmltYXRpb24sIHJlZmxvdywgYW5kIHJlcGFpbnQuIEFuIGVycm9yIHRocm93biBmcm9tIGFuIGV2ZW50IHdpbGwgbm90IGludGVycnVwdCwgbm9yIGV2ZW4gc3Vic3RhbnRpYWxseSBzbG93XG4gICAgICogZG93biB0aGUgcHJvY2Vzc2luZyBvZiBvdGhlciBldmVudHMsIGJ1dCB3aWxsIGJlIHJhdGhlciBwb3N0cG9uZWQgdG8gYSBsb3dlciBwcmlvcml0eSBldmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7e2NhbGx9fSB0YXNrIEEgY2FsbGFibGUgb2JqZWN0LCB0eXBpY2FsbHkgYSBmdW5jdGlvbiB0aGF0IHRha2VzIG5vIGFyZ3VtZW50cy5cbiAgICAgKiBAYWxpYXMgTGF6eVByb21pc2UuYXNhcFxuICAgICAqL1xuICAgIHZhciBhc2FwID0gKCgpID0+IHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJhd1Rhc2tzIGFyZSByZWN5Y2xlZCB0byByZWR1Y2UgR0MgY2h1cm4uXG4gICAgICAgICAqIEB0eXBlIHtSYXdUYXNrW119XG4gICAgICAgICAqL1xuICAgICAgICB2YXIgZnJlZVRhc2tzID0gW10sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFdlIHF1ZXVlIGVycm9ycyB0byBlbnN1cmUgdGhleSBhcmUgdGhyb3duIGluIHJpZ2h0IG9yZGVyIChGSUZPKS5cbiAgICAgICAgICogQXJyYXktYXMtcXVldWUgaXMgZ29vZCBlbm91Z2ggaGVyZSwgc2luY2Ugd2UgYXJlIGp1c3QgZGVhbGluZyB3aXRoIGV4Y2VwdGlvbnMuXG4gICAgICAgICAqIEB0eXBlIHtFcnJvcltdfVxuICAgICAgICAgKi9cbiAgICAgICAgICAgIHBlbmRpbmdFcnJvcnMgPSBbXTtcblxuICAgICAgICBjb25zdCByZXF1ZXN0RXJyb3JUaHJvdyA9IHJhd0FzYXAubWFrZVJlcXVlc3RDYWxsRnJvbVRpbWVyKCgpID0+IHtcbiAgICAgICAgICAgIGlmIChwZW5kaW5nRXJyb3JzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRocm93IHBlbmRpbmdFcnJvcnMuc2hpZnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY2xhc3MgUmF3VGFzayB7XG4gICAgICAgICAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRhc2sgPSBudWxsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjYWxsKCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGFzay5jYWxsKCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gSW4gYSB3ZWIgYnJvd3NlciwgZXhjZXB0aW9ucyBhcmUgbm90IGZhdGFsLiBIb3dldmVyLCB0byBhdm9pZFxuICAgICAgICAgICAgICAgICAgICAvLyBzbG93aW5nIGRvd24gdGhlIHF1ZXVlIG9mIHBlbmRpbmcgdGFza3MsIHdlIHJldGhyb3cgdGhlIGVycm9yIGluIGFcbiAgICAgICAgICAgICAgICAgICAgLy8gbG93ZXIgcHJpb3JpdHkgdHVybi5cbiAgICAgICAgICAgICAgICAgICAgcGVuZGluZ0Vycm9ycy5wdXNoKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdEVycm9yVGhyb3coKTtcbiAgICAgICAgICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRhc2sgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBmcmVlVGFza3NbZnJlZVRhc2tzLmxlbmd0aF0gPSB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAcGFyYW0ge3tjYWxsfX0gdGFza1xuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gX2FzYXAodGFzaykge1xuICAgICAgICAgICAgbGV0IHJhd1Rhc2s7XG4gICAgICAgICAgICBpZiAoZnJlZVRhc2tzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJhd1Rhc2sgPSBmcmVlVGFza3MucG9wKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJhd1Rhc2sgPSBuZXcgUmF3VGFzaygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmF3VGFzay50YXNrID0gdGFzaztcbiAgICAgICAgICAgIHJhd0FzYXAocmF3VGFzayk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gX2FzYXA7XG4gICAgfSkoKTtcblxuICAgIC8qKlxuICAgICAqIEJ1aWxkIGEgbGF6eSBQcm9taXNlIHRoYXQgaW5pdGlhbGl6ZSBvbmx5IHRoZSBmaXJzdCBgdGhlbmAgb3IgYGNhdGNoYC5cbiAgICAgKlxuICAgICAqIFRoZSBleGVjdXRpb24gd2lsbCBvdmVybG9hZCB0aGUgc2V0VGltZW91dC9zZXRJbnRlcnZhbC9zZXRJbW1lZGlhdGUgdGhyZWFkIHdpdGggYSBwb29sIG9mIHRhc2sgKGZvciBlYWNoIHByb21pc2UpXG4gICAgICogaGFuZGxlZCBieSB0aGUgYExhenlQcm9taXNlLmFzYXBgIChhbmQgYHJhd0FzYXBgKSBtZXRob2RzLiBBbmQgaXQncyBzZXh5LlxuICAgICAqXG4gICAgICogQG1lbWJlck9mIGphZ2dlcmJvbWIudXRpbHNcbiAgICAgKi9cbiAgICBjbGFzcyBMYXp5UHJvbWlzZSB7XG5cbiAgICAgICAgc3RhdGljIGdldCByYXdBc2FwKCkge1xuICAgICAgICAgICAgcmV0dXJuIHJhd0FzYXA7XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGljIGdldCBhc2FwKCkge1xuICAgICAgICAgICAgcmV0dXJuIGFzYXA7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogSnVzdGUgbGlrZSBhIHJlYWxcbiAgICAgICAgICoge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2ZyL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL09iamV0c19nbG9iYXV4L1Byb21pc2UgUHJvbWlzZX1cbiAgICAgICAgICpcbiAgICAgICAgICogQHNlZSBQcm9taXNlXG4gICAgICAgICAqIFxuICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmblxuICAgICAgICAgKlxuICAgICAgICAgKiBAdGhyb3cgVHlwZUVycm9yIHdoZW4gZm4gaXMgbm90IGEgZnVuY3Rpb25cbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0cnVjdG9yKGZuKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGZuICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgQnJvJyAuLi4gZm4gbWVhbnMgZnVuY3Rpb24sIG5vdCBzb21lIHNoaXQgbGlrZSAke3R5cGVvZiBmbn0geW91IHRyeSB0byBnaXZlLiBUc3NgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5jcmVhdGVkID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmZuID0gZm47XG4gICAgICAgICAgICB0aGlzLnByb21pc2UgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIENyZWF0ZSB0aGUgaW50ZXJuYWwgcHJvbWlzZSB3aGVuIHdlIG5lZWQgaXQuXG4gICAgICAgICAqXG4gICAgICAgICAqIEBwcm90ZWN0ZWRcbiAgICAgICAgICovXG4gICAgICAgIF9jcmVhdGVQcm9taXNlKCkge1xuICAgICAgICAgICAgdGhpcy5wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzYXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0cnkgeyB0aGlzLmZuKHJlc29sdmUsIHJlamVjdCk7IH1cbiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5jcmVhdGVkID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBVcGRhdGUgdGhlIGludGVybmFsIHByb21pc2UgdG8gcmUtaW5pdCB0aGUgbGF6eSBwcm9jZXNzLlxuICAgICAgICAgKlxuICAgICAgICAgKiBAcGFyYW0ge1Byb21pc2V9IHByb21pc2VcbiAgICAgICAgICovXG4gICAgICAgIHVwZGF0ZVByb21pc2UocHJvbWlzZSkge1xuICAgICAgICAgICAgaWYgKCEhcHJvbWlzZSAmJiBwcm9taXNlLl9fcHJvdG9fXy5jb25zdHJ1Y3Rvci5uYW1lID09PSAnUHJvbWlzZScpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb21pc2UgPSBQcm9taXNlLnJlc29sdmUocHJvbWlzZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAc2VlIFByb21pc2UjdGhlblxuICAgICAgICAgKlxuICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblJlc29sdmVkXG4gICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uUmVqZWN0ZWRcbiAgICAgICAgICogQHJldHVybiB7TGF6eVByb21pc2V9XG4gICAgICAgICAqL1xuICAgICAgICB0aGVuKG9uUmVzb2x2ZWQsIG9uUmVqZWN0ZWQpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5jcmVhdGVkKSB0aGlzLl9jcmVhdGVQcm9taXNlKCk7XG4gICAgICAgICAgICB0aGlzLnByb21pc2UgJiYgdGhpcy5wcm9taXNlLnRoZW4ob25SZXNvbHZlZCwgb25SZWplY3RlZCk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAc2VlIFByb21pc2UjY2F0Y2hcbiAgICAgICAgICpcbiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25SZWplY3RlZFxuICAgICAgICAgKiBAcmV0dXJuIHtMYXp5UHJvbWlzZX1cbiAgICAgICAgICovXG4gICAgICAgIGNhdGNoKG9uUmVqZWN0ZWQpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5jcmVhdGVkKSB0aGlzLl9jcmVhdGVQcm9taXNlKCk7XG4gICAgICAgICAgICB0aGlzLnByb21pc2UgJiYgdGhpcy5wcm9taXNlLmNhdGNoKG9uUmVqZWN0ZWQpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogS2lsbCAmIGRlc3Ryb3kgdGhlIHByb21pc2UgYW5kIGNhbmNlbCB0aGUgbGF6eSBjb25jZXB0LlxuICAgICAgICAgKi9cbiAgICAgICAga2lsbCgpIHtcbiAgICAgICAgICAgIHRoaXMucHJvbWlzZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCdWlsZCBhICoqc3VwZXIgbGF6eSoqIGBQcm9taXNlYCB0aGF0IGluaXRpYWxpemUgb25seSB3aGVuIHdlICphd2FrZSogaXQuXG4gICAgICpcbiAgICAgKiBMaWtlIHRoZSBjbGFzc2ljIGBMYXp5UHJvbWlzZWAsIHRoZSBleGVjdXRpb24gd2lsbCBvdmVybG9hZCB0aGUgc2V0VGltZW91dC9zZXRJbnRlcnZhbC9zZXRJbW1lZGlhdGUgdGhyZWFkIHdpdGhcbiAgICAgKiBhIHBvb2wgb2YgdGFzayAoZm9yIGVhY2ggcHJvbWlzZSkgaGFuZGxlZCBieSB0aGUgYExhenlQcm9taXNlLmFzYXBgIChhbmQgYHJhd0FzYXBgKSBtZXRob2RzLiBBbmQgaXQncyBzdXBlciBzZXh5LlxuICAgICAqXG4gICAgICogQGV4dGVuZHMgTGF6eVByb21pc2VcbiAgICAgKi9cbiAgICBjbGFzcyBTdXBlckxhenlQcm9taXNlIGV4dGVuZHMgTGF6eVByb21pc2Uge1xuICAgICAgICAvKipcbiAgICAgICAgICogSnVzdGUgbGlrZSBhIHJlYWwge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2ZyL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL09iamV0c19nbG9iYXV4L1Byb21pc2UgUHJvbWlzZX1cbiAgICAgICAgICpcbiAgICAgICAgICogQHNlZSB7UHJvbWlzZX1cbiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2ZuXSBUaGUgZXhlY3V0b3JcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0cnVjdG9yKGZuKSB7XG4gICAgICAgICAgICBzdXBlcihmbik7XG4gICAgICAgICAgICAvLyBGSUZPXG4gICAgICAgICAgICB0aGlzLnN1cGVyTGF6eVRoZW5DYXRjaCA9IFtdO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBpbmhlcml0RG9jXG4gICAgICAgICAqL1xuICAgICAgICB0aGVuKG9uUmVzb2x2ZWQsIG9uUmVqZWN0ZWQpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5jcmVhdGVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdXBlckxhenlUaGVuQ2F0Y2gucHVzaChbb25SZXNvbHZlZCwgb25SZWplY3RlZF0pO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3VwZXIudGhlbihvblJlc29sdmVkLCBvblJlamVjdGVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAaW5oZXJpdERvY1xuICAgICAgICAgKi9cbiAgICAgICAgY2F0Y2gob25SZWplY3RlZCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNyZWF0ZWQpIHtcbiAgICAgICAgICAgICAgICBpZiAob25SZWplY3RlZCAmJiB0eXBlb2Ygb25SZWplY3RlZCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN1cGVyTGF6eVRoZW5DYXRjaC5wdXNoKG9uUmVqZWN0ZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN1cGVyLmNhdGNoKG9uUmVqZWN0ZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFsbCB0aGUgc3VwZXIgbGF6eSBsb2dpYyBzdGFuZCBoZXJlLiBUaGlzIGlzIHRoZSBlbnRyeSBwb2ludCB0byBhd2FrZSB0aGUgbGF6eSBwcm9taXNlLiAgXG4gICAgICAgICAqIEF0IHRoaXMgdGltZSwgdGhlIEZJRk8gb2YgdGhlbiBhbmQgY2F0Y2ggaXMgY2FsbGVkIGJ5IGBhc2FwYCBpbiBvcmRlci5cbiAgICAgICAgICpcbiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2ZuXSBUaGUgbWF5YmUgbmV3IHByb21pc2UgZXhlY3V0b3JcbiAgICAgICAgICovXG4gICAgICAgIGF3YWtlKGZuKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mbiA9IGZuO1xuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jcmVhdGVkIHx8IHN1cGVyLl9jcmVhdGVQcm9taXNlKCk7XG4gICAgICAgICAgICBmb3IobGV0IHJlc1JlaiBvZiB0aGlzLnN1cGVyTGF6eVRoZW5DYXRjaCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzUmVqID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzYXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXRjaChyZXNSZWopO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc2FwKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGhlbiguLi5yZXNSZWopO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBleHBvcnRzLkxhenlQcm9taXNlID0gTGF6eVByb21pc2U7XG4gICAgZXhwb3J0cy5TdXBlckxhenlQcm9taXNlID0gU3VwZXJMYXp5UHJvbWlzZTtcbn0pKF9tb2R1bGUsIF9leHBvcnRzLCB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgPyBnbG9iYWwgOiB3aW5kb3cpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
